// utils/sendConfirmationEmail.js
// utils/sendConfirmationEmail.js
const axios = require('axios');
const fs = require('fs');
const path = require('path');

module.exports = async function sendConfirmationEmail(email, code4, qrCodeData) {
  const apiKey = process.env.BREVO_API_KEY;
  if (!apiKey) {
    console.warn('BREVO_API_KEY non configur√©e - email non envoy√©');
    return;
  }

  const payload = {
    sender: { 
      name: 'Bardo Academic Center for Education', 
      email: process.env.FROM_EMAIL 
    },
    to: [
      { email, name: '' } // tu peux ajouter le pr√©nom/nom si tu passes en param√®tre
    ],
    subject: `üéì Vos identifiants BACE - Code: ${code4}`,
    htmlContent: `
      <p>Bonjour,</p>
      <p>Voici votre code d'acc√®s: <strong>${code4}</strong></p>
      <p>Votre QR Code:</p>
      <img src="${qrCodeData}" alt="QR Code BACE" />
    `,
    attachment: qrCodeData ? [
      {
        name: `qrcode-bace-${code4}.png`,
        content: qrCodeData.split(',')[1] // retirer le prefix data:image/png;base64,
      }
    ] : []
  };

  const headers = {
    'api-key': apiKey,
    'Content-Type': 'application/json',
    'Accept': 'application/json'
  };

  try {
    const res = await axios.post('https://api.brevo.com/v3/smtp/email', payload, { headers });
    console.log('‚úÖ Email envoy√© √†:', email);
    return res.data;
  } catch (err) {
    console.error('‚ùå Erreur envoi email:', err?.response?.data || err.message);
    throw err;
  }
};
